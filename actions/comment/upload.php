<?php//EXTERNALSrequire "{$_SERVER['DOCUMENT_ROOT']}/actions/comment/utils.php";require "{$_SERVER['DOCUMENT_ROOT']}/actions/comment/CommentFileUpload.php";require "{$_SERVER['DOCUMENT_ROOT']}/common/boiler.php";require_common("cookies");require_common("utils");require_common("db");require_common("ImageUtils");if (isLoggedIn()) {	doUpload();} else if (isset($_COOKIE['userid'])) {	$cookieset = cookie_set();	if ($cookieset == 0) {		if (doUpload() != 0) {			echo "Your session timed out.  If you are seeing this error please <a href = '/info/reportform?type=bug'>report it</a>";		}	} else {		echo "Your session timed out.  Please ensure your browser is not blocking cookies.  Error code[".$cookieset."]";	}} else {	echo "You must be logged in to post comments.";}function doUpload() {	if (isset($_SESSION['username'])) {        echo "<!DOCTYPE html><html>	<head>		<meta http-equiv='content-type' content='text/html; charset=UTF-8' />	</head>	<style>body {color: green;}</style>	<body>		";        if (isset($_POST['comment']) && isset($_POST['number'])) {            if (isBanned($_SESSION['username'])) {                echo "You are banned.  You may not post comments";            } else if (isSuspended($_SESSION['username'])) {                echo "You are suspended.  You may not post comments";            } else {                if (isset($_POST['image']) && strlen($_POST['image']) > 0) {                    $img = ImageUtils::makeFromEncoded($_POST['image']);                    if (!$img) {                        death("decode failed");                        echo "Problem with upload.  This may be a bug in the site.";                        return -1;                    }                    $uploadok = CommentFileUpload::doFileUpload64($img, ImageUtils::getExtensionOfEncoded($_POST['image']));                } else {                    $uploadok = upload_comment(false, $_POST['comment'], $_POST['number'], $_POST['boother'], "na");                }                if (isset($uploadok['success'])) {                    echo "Uploaded OK";                } else {                    echo $uploadok['error'];                }            }        } else {            echo "Unexpected error.  Error no 0";        }        echo "	</body></html>        ";		return 0;	} else {		return -1;	}}